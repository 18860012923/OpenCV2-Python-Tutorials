

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Performance Measurement and Improvement Techniques &mdash; OpenCV-Python Tutorials 1 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="OpenCV-Python Tutorials 1 documentation" href="../../../index.html" />
    <link rel="up" title="Basic Operations on Image" href="../py_table_of_contents_core/py_table_of_contents_core.html" />
    <link rel="next" title="Mathematical Tools in OpenCV" href="../py_maths_tools/py_maths_tools.html" />
    <link rel="prev" title="Arithmetic Operations on Images" href="../py_image_arithmetics/py_image_arithmetics.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py_maths_tools/py_maths_tools.html" title="Mathematical Tools in OpenCV"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../py_image_arithmetics/py_image_arithmetics.html" title="Arithmetic Operations on Images"
             accesskey="P">previous</a> |</li>
        <li><a href="../../../index.html">OpenCV-Python Tutorials 1 documentation</a> &raquo;</li>
          <li><a href="../../py_tutorials.html" >OpenCV-Python Tutorials</a> &raquo;</li>
          <li><a href="../py_table_of_contents_core/py_table_of_contents_core.html" accesskey="U">Basic Operations on Image</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="performance-measurement-and-improvement-techniques">
<span id="optimization-techniques"></span><h1>Performance Measurement and Improvement Techniques<a class="headerlink" href="#performance-measurement-and-improvement-techniques" title="Permalink to this headline">¶</a></h1>
<div class="section" id="goal">
<h2>Goal<a class="headerlink" href="#goal" title="Permalink to this headline">¶</a></h2>
<p>In image processing, since you are dealing with large number of operations per second, it is mandatory that your code is not only providing the correct solution, but also in fastest manner. So in this chapter, you will learn</p>
<blockquote>
<div><ul class="simple">
<li>To measure the performance of your code.</li>
<li>Some tips to improve the performance of your code.</li>
<li>You will see these functions : <strong>cv2.getTickCount</strong>, <strong>cv2.getTickFrequency</strong> etc.</li>
</ul>
</div></blockquote>
<p>Apart from OpenCV, Python also provides a module <strong>time</strong> which is helpful in measuring in time of execution. Another module <strong>profile</strong> helps to get detailed report on the code, like how much time each function in the code took, how many times the function was called etc. But, if you are using IPython, all these features are integrated in an user-friendly manner. We will see some important ones, and for more details, check links in <strong>Additional Resouces</strong> section.</p>
</div>
<div class="section" id="measuring-performance-with-opencv">
<h2>Measuring Performance with OpenCV<a class="headerlink" href="#measuring-performance-with-opencv" title="Permalink to this headline">¶</a></h2>
<p><strong>cv2.getTickCount</strong> function returns the number of clock-cycles after a reference event (like the moment machine was switched ON) to the moment this function is called. So if you call it before and after the function execution, you get number of clock-cycles used to execute a function.</p>
<p><strong>cv2.getTickFrequency</strong> function returns the frequency of clock-cycles, or the number of clock-cycles per second. So to find the time of execution in seconds, you can do following:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">e1</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">getTickCount</span><span class="p">()</span>
<span class="c"># your code execution</span>
<span class="n">e2</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">getTickCount</span><span class="p">()</span>
<span class="n">time</span> <span class="o">=</span> <span class="p">(</span><span class="n">e2</span> <span class="o">-</span> <span class="n">e1</span><span class="p">)</span><span class="o">/</span> <span class="n">cv2</span><span class="o">.</span><span class="n">getTickFrequency</span><span class="p">()</span>
</pre></div>
</div>
<p>We will demonstrate with following example. Following example apply median filtering with a kernel of odd size ranging from 5 to 49. (Don&#8217;t worry about what will the result look like, that is not our goal):</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">img1</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s">&#39;messi5.jpg&#39;</span><span class="p">)</span>

<span class="n">e1</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">getTickCount</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">49</span><span class="p">,</span><span class="mi">2</span><span class="p">):</span>
    <span class="n">img1</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">medianBlur</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
<span class="n">e2</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">getTickCount</span><span class="p">()</span>
<span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">e2</span> <span class="o">-</span> <span class="n">e1</span><span class="p">)</span><span class="o">/</span><span class="n">cv2</span><span class="o">.</span><span class="n">getTickFrequency</span><span class="p">()</span>
<span class="k">print</span> <span class="n">t</span>

<span class="c"># Result I got is 0.521107655 seconds</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You can do the same with <tt class="docutils literal"><span class="pre">time</span></tt> module. Instead of <tt class="docutils literal"><span class="pre">cv2.getTickCount</span></tt>, use <tt class="docutils literal"><span class="pre">time.time()</span></tt> function. Then take the difference of two times.</p>
</div>
</div>
<div class="section" id="measuring-performance-in-ipython">
<h2>Measuring Performance in IPython<a class="headerlink" href="#measuring-performance-in-ipython" title="Permalink to this headline">¶</a></h2>
<p>Sometimes you may need to compare the performance of two similar operations. IPython gives you a magic command <tt class="docutils literal"><span class="pre">%timeit</span></tt> to perform this. It runs the code several times to get more accurate results. Once again, they are suitable to measure single line codes.</p>
<p>For example, do you know which of the following addition operation is more better, <tt class="docutils literal"><span class="pre">x</span> <span class="pre">=</span> <span class="pre">5;</span> <span class="pre">y</span> <span class="pre">=</span> <span class="pre">x**2</span></tt>, <tt class="docutils literal"><span class="pre">x</span> <span class="pre">=</span> <span class="pre">5;</span> <span class="pre">y</span> <span class="pre">=</span> <span class="pre">x*x</span></tt>, <tt class="docutils literal"><span class="pre">x</span> <span class="pre">=</span> <span class="pre">np.uint8([5]);</span> <span class="pre">y</span> <span class="pre">=</span> <span class="pre">x*x</span></tt> or <tt class="docutils literal"><span class="pre">y</span> <span class="pre">=</span> <span class="pre">np.square(x)</span></tt> ? We will find it with %timeit in IPython shell.</p>
<div class="highlight-python"><pre>In [10]: x = 5

In [11]: %timeit y=x**2
10000000 loops, best of 3: 73 ns per loop

In [12]: %timeit y=x*x
10000000 loops, best of 3: 58.3 ns per loop

In [15]: z = np.uint8([5])

In [17]: %timeit y=z*z
1000000 loops, best of 3: 1.25 us per loop

In [19]: %timeit y=np.square(z)
1000000 loops, best of 3: 1.16 us per loop</pre>
</div>
<p>You can see that, <tt class="docutils literal"><span class="pre">x</span> <span class="pre">=</span> <span class="pre">5</span> <span class="pre">;</span> <span class="pre">y</span> <span class="pre">=</span> <span class="pre">x*x</span></tt> is fastest and it is around 20x faster compared to Numpy. If you consider the array creation also, it may reach upto 100x faster. Cool, right? <em>(Numpy devs are working on this issue)</em></p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Python scalar operations are faster than Numpy scalar operations. So for operations including one or two elements, Python scalar is better than Numpy arrays. Numpy takes advantage when size of array is a little bit big.</p>
</div>
<p>We will try one more example. This time, we will compare the performance of <strong>cv2.countNonZero()</strong> and <strong>np.count_nonzero()</strong> for same image.</p>
<div class="highlight-python"><pre>In [35]: %timeit z = cv2.countNonZero(img)
100000 loops, best of 3: 15.8 us per loop

In [36]: %timeit z = np.count_nonzero(img)
1000 loops, best of 3: 370 us per loop</pre>
</div>
<p>See, OpenCV function is nearly 25x faster than Numpy function.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Normally, OpenCV functions are faster than Numpy functions. So for same operation, OpenCV functions are preferred. But, there can be exceptions, especially when Numpy works with views instead of copies.</p>
</div>
</div>
<div class="section" id="more-ipython-magic-commands">
<h2>More IPython magic commands<a class="headerlink" href="#more-ipython-magic-commands" title="Permalink to this headline">¶</a></h2>
<p>There are several other magic commands to measure the performance, profiling, line profiling, memory measurement etc. They all are well documented. So only links to those docs are provided here. Interested readers are recommended to try them out.</p>
</div>
<div class="section" id="performance-optimization-techniques">
<h2>Performance Optimization Techniques<a class="headerlink" href="#performance-optimization-techniques" title="Permalink to this headline">¶</a></h2>
<p>There are several techniques and coding methods to exploit maximum performance of Python and Numpy. Only relevant ones are noted here and links are given to important sources. The main thing to be noted here is that, first try to implement the algorithm in a simple manner. Once it is working, profile it, find the bottlenecks and optimize them.</p>
<blockquote>
<div><ol class="arabic simple">
<li>Avoid using loops in Python as far as possible, especially double/triple loops etc. They are inherently slow.</li>
<li>Vectorize the algorithm/code to the maximum possible extent because Numpy and OpenCV are optimized for vector operations.</li>
<li>Exploit the cache coherence.</li>
<li>Never make copies of array unless it is needed. Try to use views instead. Array copying is a costly operation.</li>
</ol>
</div></blockquote>
<p>Even after doing all these operations, if your code is still slow, or use of large loops are inevitable, use additional libraries like Cython to make it faster.</p>
</div>
<div class="section" id="additional-resources">
<h2>Additional Resources<a class="headerlink" href="#additional-resources" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="exercises">
<h2>Exercises<a class="headerlink" href="#exercises" title="Permalink to this headline">¶</a></h2>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/opencv-logo-white.png" alt="Logo"/>
            </a></p>
  <h3><a href="../../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Performance Measurement and Improvement Techniques</a><ul>
<li><a class="reference internal" href="#goal">Goal</a></li>
<li><a class="reference internal" href="#measuring-performance-with-opencv">Measuring Performance with OpenCV</a></li>
<li><a class="reference internal" href="#measuring-performance-in-ipython">Measuring Performance in IPython</a></li>
<li><a class="reference internal" href="#more-ipython-magic-commands">More IPython magic commands</a></li>
<li><a class="reference internal" href="#performance-optimization-techniques">Performance Optimization Techniques</a></li>
<li><a class="reference internal" href="#additional-resources">Additional Resources</a></li>
<li><a class="reference internal" href="#exercises">Exercises</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="../py_image_arithmetics/py_image_arithmetics.html"
                        title="previous chapter">Arithmetic Operations on Images</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../py_maths_tools/py_maths_tools.html"
                        title="next chapter">Mathematical Tools in OpenCV</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../../_sources/py_tutorials/py_core/py_optimization/py_optimization.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py_maths_tools/py_maths_tools.html" title="Mathematical Tools in OpenCV"
             >next</a> |</li>
        <li class="right" >
          <a href="../py_image_arithmetics/py_image_arithmetics.html" title="Arithmetic Operations on Images"
             >previous</a> |</li>
        <li><a href="../../../index.html">OpenCV-Python Tutorials 1 documentation</a> &raquo;</li>
          <li><a href="../../py_tutorials.html" >OpenCV-Python Tutorials</a> &raquo;</li>
          <li><a href="../py_table_of_contents_core/py_table_of_contents_core.html" >Basic Operations on Image</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Alexander Mordvintsev &amp; Abid K.
      Last updated on Jun 09, 2013.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>